<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
    <title layout:fragment="title">myParty | RSVP</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
</head>

<section layout:fragment="content">

    <div class="card text-center">
        <div class="card-header">
            Complete Your RSVP
        </div>

        <!--Show The Party Info-->

        <div class="card-body">
            <h1 class="card-title" th:text="${party.title}"></h1>
            <h3 class="card-text" th:text="${party.description}"></h3>
            <h6 class="card-text" th:text="'Start Time: ' + ${startTime} + ' End Time: ' + ${endTime}"></h6>
            <h6 class="card-text" th:text="'Organizer: ' + ${party.owner.firstName + ' ' + party.owner.lastName}"></h6>
            <h6 class="card-text" th:text="${party.location.addressOne} + ', ' + ${party.location.city} + ', ' + ${party.location.state} + ', ' + ${party.location.zipcode}" id="fullAddress"></h6>
            <!--TODO: Logic to show addressTwo if not null-->
        </div>

    </div>

    <div class="card-group">

    <div id='map' style='width: 25%; height: 40vh'></div>

    <div class="card text-center">
    <!--Member RSVP Form-->
    <div sec:authorize="isAuthenticated()">
        <form th:action="@{|/rsvp/${party.urlKey}/${member.id}|}" th:method="post" th:object="${partyMember}">

            <!--Prefilled Member Information-->
            <div th:text="'Name: ' + ${member.firstName} + ' ' + ${member.lastName} "></div>
            <div th:text="'Email: ' + ${member.email}"></div>

            <!--Enter RSVP Status-->
            <div class="form-group">
                <label for="rsvp1">RSVP: </label>
                <select id="rsvp1" name="rsvp">
                    <div th:each="rsvp: ${rsvps}">
                        <option th:value="${rsvp}" th:text="${rsvp}"></option>
                    </div>
                </select>
            </div>

            <div class="form-group">
                <label for="additionalGuests1">Additional Guests You're Bringing: </label>
                <select id="additionalGuests1" th:field="*{additionalGuests}">
                    <div th:each="additionalGuest : ${additionalGuests}">
                        <option th:value="${additionalGuest}" th:text="${additionalGuest}"></option>
                    </div>
                </select>
            </div>

            <!--Sign Up For Items -->
            <div class="form-group">
                <table>
                    <tr>
                        <th>Item</th>
                        <th>Quantity Requested</th>
                        <th>Quantity You're Bringing</th>
                    </tr>

                    <div th:each="partyItem : ${partyItems}">
                        <tr class="form-group">
                            <td th:text="${partyItem.key.item.name}"></td>
                            <td th:text="${partyItem.key.quantityRequired}"></td>
                            <td>
                                <select name="quantity[]">
                                    <option th:each="quantity : ${partyItem.value}" th:text="${quantity}" th:value="${quantity}"></option>
                                </select>
                            </td>
                            <input type="hidden" name="partyItem[]" th:value="${partyItem.key.id}">
                            <br>
                        </tr>
                    </div>

                </table>
            </div>
            <input type="submit" value="Submit"/>
        </form>
    </div>

    <!--Guest RSVP Form-->
    <div sec:authorize="isAnonymous()">
        <form th:action="@{|/rsvp/${party.urlKey}|}" th:method="post" th:object="${guest}" >

            <a th:href="@{|/rsvp/${party.urlKey}/login|}">Have an account? Log in here</a>

            <!--Enter First Name-->
            <div class="form-group">
                <label for="firstName">First Name: </label>
                <input class="form-control" id="firstName" type="text" th:field="*{firstName}"/>
            </div>

            <!--Enter Last Name-->
            <div class="form-group">
                <label for="lastName">Last Name: </label>
                <input class="form-control" id="lastName" type="text" th:field="*{lastName}"/>
            </div>

            <!--Enter Email-->
            <div class="form-group">
                <label for="email">Email: </label>
                <input class="form-control" id="email" type="text" th:field="*{email}"/>
            </div>

            <!--Enter RSVP Status-->
            <div class="form-group">
                <label for="rsvp">RSVP: </label>
                <select id="rsvp" name="rsvp">
                    <div th:each="rsvp: ${rsvps}">
                        <option th:value="${rsvp}" th:text="${rsvp}"></option>
                    </div>
                </select>
            </div>

            <div class="form-group">
                <label for="additionalGuests">Additional Guests You're Bringing: </label>
                <select id="additionalGuests" th:field="*{additionalGuests}">
                    <div th:each="additionalGuest : ${additionalGuests}">
                        <option th:value="${additionalGuest}" th:text="${additionalGuest}"></option>
                    </div>
                </select>
            </div>


            <!--Sign Up For Items -->
            <div class="form-group">
                <table>
                    <tr>
                        <th>Item</th>
                        <th>Quantity Requested</th>
                        <th>Quantity You're Bringing</th>
                    </tr>

                    <div th:each="partyItem : ${partyItems}">
                        <tr class="form-group">
                            <td th:text="${partyItem.key.item.name}"></td>
                            <td th:text="${partyItem.key.quantityRequired}"></td>
                            <td>
                                <select name="quantity[]">
                                    <option th:each="quantity : ${partyItem.value}" th:text="${quantity}" th:value="${quantity}"></option>
                                </select>
                            </td>
                            <input type="hidden" name="partyItem[]" th:value="${partyItem.key.id}">
                            <br>
                        </tr>
                    </div>

                </table>
            </div>

            <input type="submit" value="Submit"/>
        </form>
    </div>

    <script src="/keys.js"></script>
    <script src="/js/jquery.js"></script>
    <script src="/js/mapbox-geocoder-utils.js"></script>

    <!--Start of JS-->
    <script>
        const address = $("#fullAddress").html();

        geocode(address, mapboxApiKey).then(function (result) {
            mapboxgl.accessToken = mapboxApiKey;

            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v9',
                zoom: 15,
                center: (result)
            });

            var marker = new mapboxgl.Marker({
                draggable: true
            }).setLngLat(result).addTo(map);

        });
    </script>
</section>

<footer><p layout:fragment="custom-footer">This is actually working</p></footer>
</html>